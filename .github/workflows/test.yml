name: Review & Test

on:
  pull_request: {}
  pull_request_review_comment:
    types: [created, edited]
  workflow_dispatch:

jobs:
  golangci-lint:
    runs-on: ubuntu-latest
    name: golangci-lint
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v3.3.0
      - name: Run golangci-lint with reviewdog
        uses: reviewdog/action-golangci-lint@v2.2.2
  cypress-run:
    name: Cypress Tests
    runs-on: ubuntu-latest
    container: cypress/browsers:node-18.14.1-chrome-111.0.5563.64-1-ff-111.0-edge-111.0.1661.43-1
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      # not needed because we use container with Node preinstalled
      # - uses: actions/setup-node@v3
      #   with:
      #     node-version: 18
      - run: npm install
        working-directory: frontend
      - name: Cypress tests
        uses: cypress-io/github-action@v5.3.1
        with:
          working-directory: frontend
          build: npm run build
          component: true
          browser: firefox
        env:
          # pass GitHub token to detect new build vs re-run build
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
  build_snapshot:
    needs:
      - golangci-lint
      - cypress-run
    name: Build Snapshot
    uses: ./.github/workflows/release_generic.yml
    with:
      snapshot: true
